XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   1
F:\PTV\Pt5201\Design\DDD\SW\Master\work\peh_work\temp\xa\front.src
ADDR   CODE            LINE SOURCELINE
                          1 ; XA C compiler v2.0 r2                   SN00085795-Ccz (c) 1998 TASKING, Inc.
                          2 ; options: -A1 -Cxag3 -e -g -Ic:\cxa\include -Ic:\cxa\rtxc\xa\include -I. -Ml
                          3 ;          -O2 -s
                          5 $NOZPAGE
                          6         NAME    FRONT
                         10 ; front.c     1 /****************************************************************************/
                         11 ; front.c     2 /* MODULE:                                                                  */
                         12 ; front.c     3 /*  front.c -                                                                    
                                                                                          */
                         13 ; front.c     4 /****************************************************************************/
                         14 ; front.c     5 /* FUNCTIONS:                                                               */
                         15 ; front.c     6 /*                                                                          */
                         16 ; front.c     7 /*                                                                          */
                         17 ; front.c     8 /* TASKS:                                                                   */
                         18 ; front.c     9     void front(void);
                         19 ; front.c    10 /*                                                                          */
                         20 ; front.c    11 /* NOTES:                                                                   */
                         21 ; front.c    12 /****************************************************************************/
                         22 ; front.c    13 /*
                         23 ; front.c    14  *   PTV software for PT5201    
                         24 ; front.c    15  *   Copyright (c) 
                         25 ; front.c    16   *   ProTeleVision Technologies A/S.
                         26 ; front.c    17  *   ALL RIGHTS RESERVED
                         27 ; front.c    18 */
                         28 ; front.c    19 /****************************************************************************/
                         29 ; front.c    20 
                         30 ; front.c    21 #include "rtxcobj.h"
                        360 ; front.c    22 
                        361 ; front.c    23 #include "define.h"
                        364 ; front.c    24 #include "instru.h"
                        467 ; front.c    25 #include "KeyScan.h"
                        470 ; front.c    26 #include "KeyCodes.h"                                   // defines codes used for
                             key queue
                        473 ; front.c    27 #include "Key_hw.h"                             // Hardware interface to keyboard
                             
                        476 ; front.c    28 #include "led_hw.h"                             // Hardware interface to LEDs
                        483 ; front.c    29 
                        484 ; front.c    30 enum KeyStates                  { StateNone = 0, StateDisplay, StateSelect, State
                            Reset };
                        485 ; front.c    31 
                        486 ; front.c    32 static RepeatCnt;
                        487 ; front.c    33 static KeyState;
                        488 ; front.c    34 
                        489 ; front.c    35 /**************************************************************************/
                        490 ; front.c    36 /* front                                                                         
                                                                                                                             
                                                                               FRONT.C      */
                        491 ; front.c    37 /*                                                                               
                                                                                                                             
                                                                                                                             
                                            */
                        492 ; front.c    38 /* Author:       Kim Engedahl, DEV, 000609                                       
                                                                                                                             
                                    */
                        493 ; front.c    39 /* Revised:      000620, KEn, DEV                                                
                                                                                                                             
                                            */
                        494 ; front.c    40 /*                                                                               
                                                                                                                             
                                                                                                                             
                                            */
XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   2

ADDR   CODE            LINE SOURCELINE
                        495 ; front.c    41 /* Function:                                                                     
                                                                                                                             
                                                                                                    */
                        496 ; front.c    42 /* Remarks:                                                                      
                                                                                                                             
                                                                                                                    */
                        497 ; front.c    43 /* Returns:                                                                      
                                                                                                                             
                                                                                                                    */
                        498 ; front.c    44 /* Updates:                                                                      
                                                                                                                             
                                                                                                                    */
                        499 ; front.c    45 /**************************************************************************/
                        500 ; front.c    46 void front( void)
                        501 ; front.c    47 {
000000                  502 FRONT_PR        SEGMENT HCODE
000000                  503         RSEG    FRONT_PR
                        504         ALIGN   1
                        510         PUBLIC  _front
000000                  511 _front:
000000 0F30             515         PUSH.W  R4, R5
000002 A97E             517         ADDS.W  R7,#0EH
                        520 ; front.c    48         KeyPress key;
                        521 ; front.c    49 
                        522 ; front.c    50         key.Code = KeyNone;
000004 9278FF           524         MOV.B   [R7],#0FFH
                        525 ; front.c    51                 
                        526 ; front.c    52         for ( ;;)
000008                  528 _4:
000008                  528 _4:
000008                  529 _5:
000008                  529 _5:
000008                  530 _6:
000008                  530 _6:
000008                  531 _7:
000008                  531 _7:
000008                  532 _8:
                        533 ; front.c    53         {
                        534 ; front.c    54                 KeyScanStream->Get( KeyScanStream, &key);
000008 964842rr         536         MOV.B   ES,#SEG( _KeyScanStream )
00000C 9918rrrr         537         MOV.W   R1,#SOF( _KeyScanStream )
000010 8B01             538         MOV.W   R0,[R1+]
000012 8A11             539         MOV.W   R1,[R1]
000014 862C42           540         MOV.B   ES,R1L
000017 8C400A           541         MOV.W   R4,[R0+10]
00001A 8C500C           542         MOV.W   R5,[R0+12]
00001D 9168rr           543         MOV.B   R3L,#SEG( __lc_bs )
000020 7177             544         XOR.B   R3H,R3H
000022 8927             545         MOV.W   R2,R7
000024 C4rrrrrr         546         FCALL   __ICALL
                        547 ; front.c    55 
                        548 ; front.c    56                 switch ( key.Code)
000028 9274FF           550         CMP.B   [R7],#0FFH
00002B F304             551         BEQ     _9
00002D 9274CF           552         CMP.B   [R7],#0CFH
000030 F327             553         BEQ     _15
000032 FEEA             554         BR      _4
                        555 ; front.c    57                 {
                        556 ; front.c    58                         case KeyNone:
000034                  558 _9:
                        559 ; front.c    59                                         switch ( KeyState)
000034 964842rr         561         MOV.B   ES,#SEG( _KeyState )
XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   3

ADDR   CODE            LINE SOURCELINE
000038 9908rrrr         562         MOV.W   R0,#SOF( _KeyState )
00003C 8A00             563         MOV.W   R0,[R0]
00003E 99040003         564         CMP.W   R0,#03H
000042 F304             565         BEQ     _10
000044 99040002         566         CMP.W   R0,#02H
000048 F304             567         BEQ     _11
00004A FE0B             568         BR      _14
                        569 ; front.c    60                                         {
                        570 ; front.c    61                                                 case StateReset:
00004C                  572 _10:
                        573 ; front.c    62                                                         ResetInstrument();
                        575         CALL    _ResetInstrument
00004C C4rrrrrr        +575 ;       FCALL   _ResetInstrument
                        576 ; front.c    63                                                         break;
000050 FE08             578         BR      _14
                        579 ; front.c    64 
                        580 ; front.c    65                                                 case StateSelect:
000052                  582 _11:
                        583 ; front.c    66                                                         if ( Settings.ActivePrese
                            t)
000052 964842rr         585         MOV.B   ES,#SEG( _Settings )
000056 9908rrrr         586         MOV.W   R0,#SOF( _Settings )
00005A 8A00             587         MOV.W   R0,[R0]
00005C F302             588         BEQ     _14
                        589 ; front.c    67                                                                 RecallPreset( Set
                            tings.ActivePreset);
                        591         CALL    _RecallPreset
00005E C4rrrrrr        +591 ;       FCALL   _RecallPreset
                        592 ; front.c    68                                                         break;
                        593 ; front.c    69                                         }
000062                  595 _14:
                        596 ; front.c    70 
                        597 ; front.c    71                                         KeyState = StateNone;
000062 964842rr         599         MOV.B   ES,#SEG( _KeyState )
000066 9908rrrr         600         MOV.W   R0,#SOF( _KeyState )
00006A BA00             601         MOV.W   [R0],#00H
                        602 ; front.c    72 
                        603 ; front.c    73                                         Sleep( 100);                             
                                                                    // Display LEDs for 100ms before returning to normal
00006C 99080064         605         MOV.W   R0,#064H
                        606         CALL    _Sleep
000070 C4rrrrrr        +606 ;       FCALL   _Sleep
                        607 ; front.c    74 
                        608 ; front.c    75                                         SystemsLEDSet( NormLEDs, 0);
000074 911800           610         MOV.B   R0H,#00H
000077 8101             611         MOV.B   R0L,R0H
                        612         CALL    _SystemsLEDSet
000079 C4rrrrrr        +612 ;       FCALL   _SystemsLEDSet
                        613 ; front.c    76                                         break;
00007D FEC5             615         BR      _8
                        616 ; front.c    77 
                        617 ; front.c    78                                 case KeyExecute:
000080                  619 _15:
                        620 ; front.c    79                                         switch ( key.Repeat)
000080 94740100         622         CMP.B   [R7+1],#00H
000084 F307             623         BEQ     _16
000086 94740102         624         CMP.B   [R7+1],#02H
00008A F319             625         BEQ     _17
00008C 94740103         626         CMP.B   [R7+1],#03H
000090 F34D             627         BEQ     _20
000092 FEBA             628         BR      _4
                        629 ; front.c    80                                         {
XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   4

ADDR   CODE            LINE SOURCELINE
                        630 ; front.c    81                                                 case RepeatOff:                  
                                                            // Display active preset, (if any)
000094                  632 _16:
                        633 ; front.c    82                                                         SystemsLEDSet( PresetLEDs
                            , Settings.ActivePreset);
000094 910801           635         MOV.B   R0L,#01H
000097 964842rr         636         MOV.B   ES,#SEG( _Settings )
00009B 9918rrrr         637         MOV.W   R1,#SOF( _Settings )
00009F 8A11             638         MOV.W   R1,[R1]
0000A1 8112             639         MOV.B   R0H,R1L
                        640         CALL    _SystemsLEDSet
0000A3 C4rrrrrr        +640 ;       FCALL   _SystemsLEDSet
                        641 ; front.c    83 
                        642 ; front.c    84                                                         RepeatCnt = 0;
0000A7 964842rr         644         MOV.B   ES,#SEG( _RepeatCnt )
0000AB 9908rrrr         645         MOV.W   R0,#SOF( _RepeatCnt )
0000AF BA00             646         MOV.W   [R0],#00H
                        647 ; front.c    85 
                        648 ; front.c    86                                                         KeyState = StateDisplay;
0000B1 964842rr         650         MOV.B   ES,#SEG( _KeyState )
0000B5 9908rrrr         651         MOV.W   R0,#SOF( _KeyState )
0000B9 BA01             652         MOV.W   [R0],#01H
                        653 ; front.c    87                                                         break;
0000BB FEA6             655         BR      _7
                        656 ; front.c    88 
                        657 ; front.c    89                                                 case Repeat2:                    
                                                                    // Display/select next preset when releasing button
0000BE                  659 _17:
                        660 ; front.c    90                                                         if ( RepeatCnt-- == 0)
0000BE 964842rr         662         MOV.B   ES,#SEG( _RepeatCnt )
0000C2 9908rrrr         663         MOV.W   R0,#SOF( _RepeatCnt )
0000C6 8A00             664         MOV.W   R0,[R0]
0000C8 8910             665         MOV.W   R1,R0
0000CA A90F             666         ADDS.W  R0,#0FH
0000CC 964842rr         667         MOV.B   ES,#SEG( _RepeatCnt )
0000D0 9928rrrr         668         MOV.W   R2,#SOF( _RepeatCnt )
0000D4 8A0A             669         MOV.W   [R2],R0
0000D6 6911             670         OR.W    R1,R1
0000D8 F222             671         BNE     _19
                        672 ; front.c    91                                                         {
                        673 ; front.c    92                                                                 RepeatCnt = 2;
0000DA 964842rr         675         MOV.B   ES,#SEG( _RepeatCnt )
0000DE 9908rrrr         676         MOV.W   R0,#SOF( _RepeatCnt )
0000E2 BA02             677         MOV.W   [R0],#02H
                        678 ; front.c    93 
                        679 ; front.c    94                                                                 if ( ++Settings.A
                            ctivePreset > NoOfPresets)
0000E4 964842rr         681         MOV.B   ES,#SEG( _Settings )
0000E8 9908rrrr         682         MOV.W   R0,#SOF( _Settings )
0000EC 8A00             683         MOV.W   R0,[R0]
0000EE A901             684         ADDS.W  R0,#01H
0000F0 964842rr         685         MOV.B   ES,#SEG( _Settings )
0000F4 9918rrrr         686         MOV.W   R1,#SOF( _Settings )
0000F8 8A09             687         MOV.W   [R1],R0
0000FA 99040004         688         CMP.W   R0,#04H
0000FE FD05             689         BLE     _18
                        690 ; front.c    95                                                                         Settings.
                            ActivePreset = 0;
000100 964842rr         692         MOV.B   ES,#SEG( _Settings )
000104 9908rrrr         693         MOV.W   R0,#SOF( _Settings )
000108 BA00             694         MOV.W   [R0],#00H
000108 BA00             694         MOV.W   [R0],#00H
XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   5

ADDR   CODE            LINE SOURCELINE
00010A                  695 _18:
                        696 ; front.c    96 
                        697 ; front.c    97                                                                 SystemsLEDSet( Pr
                            esetLEDs, Settings.ActivePreset);
00010A 910801           699         MOV.B   R0L,#01H
00010D 964842rr         700         MOV.B   ES,#SEG( _Settings )
000111 9918rrrr         701         MOV.W   R1,#SOF( _Settings )
000115 8A11             702         MOV.W   R1,[R1]
000117 8112             703         MOV.B   R0H,R1L
                        704         CALL    _SystemsLEDSet
000119 C4rrrrrr        +704 ;       FCALL   _SystemsLEDSet
                        705 ; front.c    98                                                         }
00011E                  707 _19:
                        708 ; front.c    99 
                        709 ; front.c   100                                                         KeyState = StateSelect;
00011E 964842rr         711         MOV.B   ES,#SEG( _KeyState )
000122 9908rrrr         712         MOV.W   R0,#SOF( _KeyState )
000126 BA02             713         MOV.W   [R0],#02H
                        714 ; front.c   101                                                         break;
                        716         BR      _6
000128 D5FF6F          +716         JMP.L   _6
                        717 ; front.c   102 
                        718 ; front.c   103                                                 case Repeat3:                    
                                                                    // Reset the unit when releasing button
00012C                  720 _20:
                        721 ; front.c   104                                                         KeyState = StateReset;
00012C 964842rr         723         MOV.B   ES,#SEG( _KeyState )
000130 9908rrrr         724         MOV.W   R0,#SOF( _KeyState )
000134 BA03             725         MOV.W   [R0],#03H
                        726 ; front.c   105 
                        727 ; front.c   106                                                         SystemsLEDSet( ResetLEDs,
                             0);
000136 910802           729         MOV.B   R0L,#02H
000139 911800           730         MOV.B   R0H,#00H
                        731         CALL    _SystemsLEDSet
00013C C4rrrrrr        +731 ;       FCALL   _SystemsLEDSet
                        733         BR      _5
000140 D5FF63          +733         JMP.L   _5
                        734 ; front.c   107                                                         break;
                        735 ; front.c   108                                         }
                        736 ; front.c   109                                         break;
                        737 ; front.c   110                 }
                        738 ; front.c   111         }
                        739 ; front.c   112 }
000143 A972             741         ADDS.W  R7,#02H
000145 2F30             743         POP.W   R4, R5
000147 D680             745         RET
000000                  750 FRONT_CLR_FA    SEGMENT HDATA INSEGMENT CLEAR
000000                  751         RSEG    FRONT_CLR_FA
                        752         ALIGN   1
000000                  753 _RepeatCnt:     DS      2
   |  RESERVED             
000001
                        757         EXTRN   HDATA(_KeyScanStream)
                        759         EXTRN   HDATA(_Settings)
                        762         EXTRN   HCODE(_SystemsLEDSet)
                        763         EXTRN   HCODE(__ICALL)
                        766         EXTRN   HCODE(_RecallPreset)
                        767         EXTRN   IDATA(__lc_bs)
                        770         EXTRN   HCODE(_ResetInstrument)
                        773         EXTRN   HCODE(_Sleep)
                        775         ALIGN   1
XA assembler v2.0 r2                    SN00085795-037 (c) 1998 TASKING, Inc.
                                                                                                                            Page   6

ADDR   CODE            LINE SOURCELINE
000002                  776 _KeyState:      DS      2
   |  RESERVED             
000003
                        777         EXTRN   DATA(__lc_ub_xvwbuffer)
                        778         EXTRN   DATA(__lc_ue_xvwbuffer)
                        779         CALLS   'front', 'ResetInstrument'
                        780         CALLS   'front', 'RecallPreset'
                        781         CALLS   'front', 'Sleep'
                        782         CALLS   'front', 'SystemsLEDSet'
