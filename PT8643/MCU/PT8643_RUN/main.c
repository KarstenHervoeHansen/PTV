//#define DEBUG_MCU
//------------------------------------------------------------------------------
// main.c
//------------------------------------------------------------------------------
// Copyright (C) 2005 Silicon Laboratories, Inc.
//
// Date: 06/25/10 13:15:25
// Target: C8051F12x 
//
// Description:
//    This file contains the main routine, MCU initialization code, and
//    callback functions used by the TCP/IP Library.
//
// Generated by TCP/IP Configuration Wizard Version 3.23
//
#include <c8051F120.h>                         // Device-specific SFR Definitions
#include <stdio.h>                         	   // SPRINTF
#include <string.h>
#include "mn_userconst.h"                      // TCP/IP Library Constants
#include "mn_stackconst.h"                     // TCP/IP Library Constants
#include "mn_errs.h"                           // Library Error Codes
#include "mn_defs.h"                           // Library Type definitions
#include "mn_funcs.h"                          // Library Function Prototypes
#include "netfinder.h"
#include "ini.h"
#include "uart_0.h"
#include "ntp.h"
#include "ublox_prot.h"
#include "i2c_slave.h"
#include "i2c_bus.h"
#include "telnet.h"
#include "uart_1.h"

//-----------------------------------------------------------------------------
// 16-bit SFR Definitions for 'F12x
//-----------------------------------------------------------------------------
sfr16 RCAP2    = 0xca;                         // Timer2 reload value
sfr16 TMR2     = 0xcc;                         // Timer2 counter
sfr16 ADC0     = 0xbe;                         // ADC0 data register
 
//------------------------------------------------------------------------------
// Global Constants
//------------------------------------------------------------------------------
#define SYSCLK                  98000000L      // System Clock Frequency in Hz
#define T2_OVERFLOW_RATE        130L           // Timer 2 Overflow Rate in Hz

//------------------------------------------------------------------------------
// Function Prototypes
//------------------------------------------------------------------------------
void ReadMAC(void);
int establish_network_connection();
int test = 204;
//------------------------------------------------------------------------------
// Global Variables
//------------------------------------------------------------------------------

unsigned char bdata BOOT _at_ 0x2F;				// Used for Interrupt redirection.

sbit			LED1						= P2^4;
sbit			LED2						= P2^5;
sbit			LED3						= P2^6;
sbit			LED4						= P2^7;


sbit    		INT0						= P0^4;
sbit    		GPS_LOCK					= P3^3;
sbit    		GPS_REQ						= P3^2;		// Request leap seconds data.
sbit			ETH_RES						= P4^5;

bit				b_write_network_settings	= 0;
char			GPS_AID_First_Req;						// Counting down, when 0 then request the GPS AID-HUI information.

//signal qualities
char 			signal_quality[16]    = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
				// Signal Quality indicator (range 0..7). The following list shows the meaning of the different QI values: 
				// 0: This channel is idle
				// 1, 2: Channel is searching
				// 3: Signal detected but unusable
				// 4: Code Lock on Signal
				// 5, 6: Code and Carrier locked
				// 7: Code and Carrier locked, receiving 50bps data 

unsigned char	signal_strength[16]   = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

xdata unsigned char Netfinder_Name[32] = {0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20};

unsigned char   SNTP_Enable			= -3;
int 			iDHCPRenew          = 1;

unsigned char  	Software_WD			= 0xFF;

#ifdef DEBUG_MCU		
	unsigned char DebugString[128];
#endif

//-----------------------------------------------------------------------------
// Main Routine
//-----------------------------------------------------------------------------
void main(void)
{
	unsigned char j;
	int retval = 0;
	int ntpstart = -1;
	int netfinderstart = -1;
	unsigned int i;

	// Disable watchdog timer
	WDTCN = 0xDE;
	WDTCN = 0xAD;

	//WDTCN = 0xA5;

//	BOOT = 1;

	// Initialize the MCU
    IE        = 0x00;
    IP        = 0x00;
    EIE1      = 0x00;
    EIE2      = 0x00;
	
	SFRPAGE   = TIMER01_PAGE;
    TCON      = 0x00;
    TMOD      = 0x00;
    CKCON     = 0x00;

	MCUInit();
	BOOT = 1;
	Flush_COM0buffers();
	
	UTC_time_buffer.year = 0;
	UTC_time_buffer.month = 0;
	UTC_time_buffer.day = 0;
	UTC_time_buffer.hour = 0;
	UTC_time_buffer.min = 0;
	UTC_time_buffer.sec = 0;
	
	UTC_Boot_Time.year = 0;
	UTC_Boot_Time.month = 0;
	UTC_Boot_Time.day = 0;
	UTC_Boot_Time.hour = 0;
	UTC_Boot_Time.min = 0;
	UTC_Boot_Time.sec = 0;

	#ifdef DEBUG_MCU		
	    SFRPAGE   = TMR4_PAGE;
	    RCAP4L    = 0xCB; // 115200 Baud.
	    RCAP4H    = 0xFF; // 115200 Baud.

		i2c_set_rs232dest(RS232_DSUB_MCU);
		sprintf(DebugString, "Booting RUN Code...\n\r");
		str2COM0(&DebugString, 0x00);	
	#endif

	LED1 = 0;
	LED2 = 0;

    for(i=0; i<100; i++){i2c_delay();}
   
 	SFRPAGE = CONFIG_PAGE;
	ETH_RES = 0;
	sdelay();
	ETH_RES = 1;
	while(ETH_RES == 0)							// Wait for CP2200 startup completes.
	{	
		retval++;
		if (retval >= 100) break;
	}
	ReadMAC();

	setup_I2C();

	UTC_leap_buffer.utc_leap_second = 0;

	while(1)
	{
		//WDTCN = 0xA5;

		// Initialize the TCP/IP stack.
		EIE2 &= (~0x40); // Clear bit. (Disable UART1 Interrupt...)
						 // UART1 MUST NOT be enabled while mn_ether_init is running.
		
		while (mn_init() < 0);

		/*
			CPFLASH_ByteWrite(0x1FFA, 0x00);
			CPFLASH_ByteWrite(0x1FFB, 0x0B);
			CPFLASH_ByteWrite(0x1FFC, 0x3C);
			CPFLASH_ByteWrite(0x1FFD, 0x00);
			CPFLASH_ByteWrite(0x1FFE, 0x51);
			CPFLASH_ByteWrite(0x1FFF, 0x75);
		*/

		// Connect to the network

		retval = establish_network_connection();

		#ifdef DEBUG_MCU		
			sprintf(DebugString, "Establish Network Connection : %i\n\r", retval);
			str2COM0(&DebugString, 0x00);	
		#endif
		
		retval = 0x1c00; // Reuse retval. 
		if ( (CPFLASH_ByteRead(retval) != 0x02) ) // #define CP2201_Flash_Prog 0x1C00; (0x02)
		{									  // Indicates if the CP2201 Flash has been initialized. If 0xFF flash has not been initialized.
			ETHFlashReset();
		}

		retval = CP2201_Flash_Name;
	    for(j = 0; j < 32; j++)
		{
			Netfinder_Name[j] = CPFLASH_ByteRead(retval);
			retval++;
		}

		EIE2 |= 0x40;		// Set bit. (Disable UART1 Interrupt...)
						 	// UART1 interrupt MUST NOT be enabled while mn_ether_init is running.

		retval = CP2201_Flash_TelnetPort;
		TELNET_PORT = CPFLASH_ByteRead(retval) << 8;
		TELNET_PORT |= CPFLASH_ByteRead(retval + 1);

		EX1 = 1;
		TELNET_Enable = CPFLASH_ByteRead(0x1C50);
		if  (TELNET_Enable == 0) telnet_socketstate = DISABLED;
			else telnet_socketstate = DISCONNECTED;


		DHCP_Enable = CPFLASH_ByteRead(0x1C41);
		if (DHCP_Enable != 0x00) DHCP_Enable = 0x01;

		if (DHCP_Enable == 0x00) // Override DHCP.
		{
			#ifdef DEBUG_MCU		
				sprintf(DebugString, "DHCP client disabled.\n\r");
				str2COM0(&DebugString, 0x00);	
			#endif			// Disable DHCP...
			// Update IP Address
	    	ip_src_addr[0] = CPFLASH_ByteRead(0 + 0x1C42);
		    ip_src_addr[1] = CPFLASH_ByteRead(1 + 0x1C42);
		    ip_src_addr[2] = CPFLASH_ByteRead(2 + 0x1C42);
		    ip_src_addr[3] = CPFLASH_ByteRead(3 + 0x1C42);
         
		    // Update Subnet Mask
		    subnet_mask[0] = CPFLASH_ByteRead(4 + 0x1C42);
		    subnet_mask[1] = CPFLASH_ByteRead(5 + 0x1C42);
		    subnet_mask[2] = CPFLASH_ByteRead(6 + 0x1C42);
		    subnet_mask[3] = CPFLASH_ByteRead(7 + 0x1C42);
	        
		    // Update Default Gateway
		    gateway_ip_addr[0] = CPFLASH_ByteRead(8 + 0x1C42);
		    gateway_ip_addr[1] = CPFLASH_ByteRead(9 + 0x1C42);
		    gateway_ip_addr[2] = CPFLASH_ByteRead(10 + 0x1C42);
		    gateway_ip_addr[3] = CPFLASH_ByteRead(11 + 0x1C42);
 	
	        iDHCPRenew = 1;
			dhcp_lease.infinite_lease = 1;			// This is important, if this is not set 
	        dhcp_lease.dhcp_state = DHCP_OVERRIDE; 	// no connection can be established.

		}
		else
		{
			// Use DHCP to obtain an IP address.

			#ifdef DEBUG_MCU		
				sprintf(DebugString, "DHCP client enabled.\n\r");
				str2COM0(&DebugString, 0x00);	
			#endif

			if (mn_dhcp_start(PTR_NULL, dhcp_default_lease_time) <= 0)
			{
			   // DHCP Error
			   // The DHCP server did not assign a valid IP address.
				#ifdef DEBUG_MCU		
					sprintf(DebugString, "Obtaining DHCP Address FAILED\n\r");
					str2COM0(&DebugString, 0x00);	
				#endif
   		
			   // Override DHCP
			   iDHCPRenew = 1;
			   dhcp_lease.infinite_lease = 1;
			   dhcp_lease.dhcp_state = DHCP_OK;
		
			   // Specify a static IP address
			   ip_src_addr[0] = 0;
			   ip_src_addr[1] = 0;
			   ip_src_addr[2] = 0;
			   ip_src_addr[3] = 1;
			}
		}

		#ifdef DEBUG_MCU		
			sprintf(DebugString, "            MAC : %02X:%02X:%02X:%02X:%02X:%02X\n\r", (int)eth_src_hw_addr[0],(int)eth_src_hw_addr[1],(int)eth_src_hw_addr[2],(int)eth_src_hw_addr[3],(int)eth_src_hw_addr[4],(int)eth_src_hw_addr[5]);
			str2COM0(&DebugString, 0x00);
			sprintf(DebugString, "    ip_src_addr : %03i.%03i.%03i.%03i\n\r", (int)ip_src_addr[0],(int)ip_src_addr[1],(int)ip_src_addr[2],(int)ip_src_addr[3]);
			str2COM0(&DebugString, 0x00);
			sprintf(DebugString, "    subnet_mask : %03i.%03i.%03i.%03i\n\r", (int)subnet_mask[0],(int)subnet_mask[1],(int)subnet_mask[2],(int)subnet_mask[3]);
			str2COM0(&DebugString, 0x00);
			sprintf(DebugString, "gateway_ip_addr : %03i.%03i.%03i.%03i\n\r", (int)gateway_ip_addr[0],(int)gateway_ip_addr[1],(int)gateway_ip_addr[2],(int)gateway_ip_addr[3]);
			str2COM0(&DebugString, 0x00);	
		#endif

		// Start the Netfinder Service
		netfinderstart = netfinder_start(); // DEBUG DISABLED BS 2012-05-24
		
		#ifdef DEBUG_MCU		
			sprintf(DebugString, "Netfinder Start : %i\n\r", netfinderstart);
			str2COM0(&DebugString, 0x00);	
		#endif

		// Start the NTP Service
		ntpstart = ntp_start();
		#ifdef DEBUG_MCU		
			sprintf(DebugString, "      NTP Start : %i\n\r", ntpstart);
			str2COM0(&DebugString, 0x00);	
		#endif
		// Start the Telnet Service
		if (TELNET_Enable == 1)
		{
			retval = telnet_start();
			#ifdef DEBUG_MCU		
				sprintf(DebugString, "   Telnet Start : %i\n\r", retval);
				str2COM0(&DebugString, 0x00);	
			#endif
		}	
		// Start the Application Layer Services
		// If this routine exits, check the return value for an error code.
	
		if ( (ntpstart >= 0) && (netfinderstart >= 0) ) // DEBUG DISABLED BS 2012-05-24
		//sprintf(Netfinder_Name,"NetFinder protocol DISABLED");
		//if ( (ntpstart >= 0) ) // DEBUG ENABLED BS 2012-05-24
		{
			GPS_REQ	= 1;
			GPS_AID_First_Req = 29;

			#ifdef DEBUG_MCU		
				sprintf(DebugString, "Server START    (%04i-%02i-%02i %02i:%02i:%02i)\n\r", (int)UTC_time_buffer.year, (int)UTC_time_buffer.month, (int)UTC_time_buffer.day, (int)UTC_time_buffer.hour, (int)UTC_time_buffer.min, (int)UTC_time_buffer.sec);
				str2COM0(&DebugString, 0x00);	
			#endif

			UTC_ServerStart_Time.year = 0;
			UTC_ServerStart_Time.month = 0;
			UTC_ServerStart_Time.day = 0;
			UTC_ServerStart_Time.hour = 0;
			UTC_ServerStart_Time.min = 0;
			UTC_ServerStart_Time.sec = 0;

			retval = mn_server();
			Software_WD = 0xFF;

			#ifdef DEBUG_MCU		
				sprintf(DebugString, "Server STOP : %i (%04i-%02i-%02i %02i:%02i:%02i)\n\r", retval, (int)UTC_time_buffer.year, (int)UTC_time_buffer.month, (int)UTC_time_buffer.day, (int)UTC_time_buffer.hour, (int)UTC_time_buffer.min, (int)UTC_time_buffer.sec);
				str2COM0(&DebugString, 0x00);	
			#endif

			if (b_write_network_settings == 1)
			{
				#ifdef DEBUG_MCU		
					sprintf(DebugString, "Writing network settings.\n\r");
					str2COM0(&DebugString, 0x00);	
				#endif

				b_write_network_settings = 0;
				write_network_settings();
				//ethernet_reconfigure = 1;
			}
		}
		else
		{
			LED2 = 1;
			LED3 = 1;
		}
	}
}

//-----------------------------------------------------------------------------
// establish_network_connection
//-----------------------------------------------------------------------------
//
// This function calls mn_ether_init() to initialize the CP2200 and attach to
// the network.
//
// If there is a network connection, the function returns 1.
//
// In the call to mn_ether_init(), NUM_AUTONEG_ATTEMPTS is set to 0, so the
// function will not return until it successfully auto-negotiates.
//
// mn_ether_init() will not be a blocking call if NUM_AUTONEG_ATTEMPTS is set
// to a value greater than 0.
//
int establish_network_connection()
{
   int retval;

   do
   {
		// mn_ether_init() initializes the Ethernet controller.
		// AUTO_NEG indicates that the controller will auto-negotiate.

		retval = mn_ether_init(AUTO_NEG, 1, 0);
      	//WDTCN = 0xA5;

		// If there is no link, poll link_status until it sets or the
		// CP2200 resets and then call mn_ether_init() again.
		if (retval == LINK_FAIL)
		{
			//i2c_set_rs232dest(RS232_DSUB_MCU);
			while(!link_status && !ether_reset)
			{
				#ifdef DEBUG_MCU		
					UART1();		// In debug mode this will update the timestamp on debug messages.
				#endif
			};
		}

		// If retval is less than zero and is not LINK_FAIL, there is a 
		// hardware error.
		else if (retval < 0)
		{
			// Verify that the Ethernet controller is connected and powered properly.
			// Verity that the EMIF has been configured at a speed compatible with the
			//    Ethernet controller.

			//while(1);
		}

	}while(retval < 0);

	return (1);

}


//-----------------------------------------------------------------------------
// Interrupt Service Routines
//-----------------------------------------------------------------------------
// Timer 2 interrupt could be enabled in bootloader so this procedure must be here.
void Timer2_ISR (void) interrupt 5
{
	TF2 = 0;
}
//-----------------------------------------------------------------------------
// Timer4_ISR (T2_OVERFLOW_RATE Hz)
//-----------------------------------------------------------------------------
//
void Timer4_ISR (void) interrupt 16 using 2 //5
{
	int retval = 0;
	char SFRPAGE_SAVE = SFRPAGE;     // Save Current SFR page

	// Clear Timer 2 Overflow Flag
	SFRPAGE = TMR4_PAGE;
	TF4 = 0;

	EX1 = 0;
	sec_frac++;
	if (sec_frac >= 200) //204
	{
		sec_counter++;
		sec_frac = 2;// 4; // 0
	}
	EX1 = 1;


	if ((telnet_socketstate > IDLE) && (telnet_socketstate < DISABLED) && (telnet_InactivityTimer > 0x0000))
	{
		telnet_InactivityTimer -= 1;
		if (telnet_InactivityTimer == 0x0000)
		{
			telnet_socketstate = DISCONNECTED; //mn_close(telnet_socketno);
		}

	}

	//packet_process(); // UBLOX... // Processed in server idle.
	
	// Check if the NTP module has flagged that a socket reset is required.
	// If so, then start the socket reset delay.
/*
	if(ntp_need_reset_socket == 1) {ntp_reset_socket_delay++;}
	
	if (ntp_reset_socket_delay >= 50)
	{
		// Reset Socket
		ntp_reset_socket_delay = 0x00;
		ntp_need_reset_socket = 0;

		mn_close(ntp_socketno);
		retval = ntp_start();
	}
*/
/*
	if(netfinder_need_reset_socket == 1) {netfinder_reset_socket_delay++;}
	
	if (netfinder_reset_socket_delay >= 5)
	{
		// Reset Socket
		netfinder_reset_socket_delay = 0x00;
		netfinder_need_reset_socket = 0;

		mn_close(netfinder_socketno);
		netfinder_start();
	}
*/
/*
	if (Software_WD != 0xFF) Software_WD++;
	if (Software_WD == 254)
	{
		BOOT = 0;
		WDTCN = 0xA5;
		RSTSRC = 0x10;
	}
*/
	//LED4 = !LED4;
	SFRPAGE = SFRPAGE_SAVE;       	// Restore SFR page
}

//-----------------------------------------------------------------------------
// ether_reset_low
//-----------------------------------------------------------------------------
//
// This routine drives the reset pin of the ethernet controller low.
//
void ether_reset_low()
{

   unsigned char SFRPAGE_Save;

   SFRPAGE_Save = SFRPAGE;    // Save Current SFR page
   SFRPAGE = CONFIG_PAGE;     // Switch to ports SFR page

   P4 &= ~0x20;               // Pull reset low

   SFRPAGE = SFRPAGE_Save;    // Restore SFR page

}

//-----------------------------------------------------------------------------
// ether_reset_high
//-----------------------------------------------------------------------------
//
// This routine places the reset pin in High-Z allowing it to be pulled up 
// using the external pull-up resistor.
//
// Additionally, this routine waits for the reset pin to read high before
// exiting.
//
void ether_reset_high (void)
{

   unsigned char SFRPAGE_Save;

   SFRPAGE_Save = SFRPAGE;    // Save Current SFR page
   SFRPAGE = CONFIG_PAGE;     // Switch to ports SFR page

   P4 |= 0x20;               // Allow /RST to rise
   while(!(P4 & 0x20));      // Wait for /RST to go high

   SFRPAGE = SFRPAGE_Save;    // Restore SFR page


}


void ext_int1_ISR() interrupt 2 using 2 // 1PPS
{
	if (GPS_AID_First_Req == 0)
	{
		GPS_AID_First_Req = -1;
		GPS_REQ	= 0;	// Request GPS AID-HUI (Leap second information.)
		LED1 = 0;
	}
	else if (GPS_AID_First_Req > 0)
	{
		GPS_AID_First_Req--;
	}

	if ( (UTC_time_buffer.hour == 00) && (UTC_time_buffer.min == 00) && (UTC_time_buffer.sec == 00) ) GPS_REQ = 0; // Request Leap Second Information at Midnight

	if ((UTC_Boot_Time.year == 0) && (UTC_time_buffer.year > 0)) UTC_Boot_Time = UTC_time_buffer;
	if ((UTC_ServerStart_Time.year == 0) && (UTC_time_buffer.year > 0)) UTC_ServerStart_Time = UTC_time_buffer;

	EIE2 &= (~0x04); // Clear bit. (Stop Timer 4.)
		sec_frac = 2;
		sec_counter = sec_preload_counter;
	EIE2 |= 4; // Set bit. (Start Timer 4.)
	
	if (GPS_LOCK == 1)
	{
		gps_lock_timeout = 0x00;
		LED3 = 1;
	}
	else if ((GPS_LOCK == 0) && (gps_lock_timeout < GPS_LOCK_TIMEOUT)) gps_lock_timeout++;
	else if (gps_lock_timeout >= GPS_LOCK_TIMEOUT) LED3 = 0;

	if (SNTP_Enable != 1) { SNTP_Enable++; }

	LED4 = !LED4;
}

//-----------------------------------------------------------------------------
// read_flash_addr	: Read a byte from MCU flash memory. (Code memory.)
//-----------------------------------------------------------------------------
unsigned char read_flash_addr(unsigned int readaddress)
{
	char code* data pread;                 // pointer used for reading FLASH
	pread = readaddress;
	return *pread;
}


//-----------------------------------------------------------------------------
// ReadMAC : The correct MAC address will not be shown if network cable
//         : is disconnected. This corrects it...
//-----------------------------------------------------------------------------
void ReadMAC(void)
{
	unsigned char i, j;
	char xdata *p;

    bit	EA_state = EA;								// Holds interrupt state

	EA = 0;
	ETH_RES = 1;

	p = 0x2068;	// Set Address pointer Low.
	*p = 0xFA;
	p = 0x2069; // Set Address pointer High.
	*p = 0x1F;
	p = 0x2005; // Auto Read Flash...

	i2c_delay(); // A small delay is necessary before data can be read from flash...
    for( i = 0; i < 6; i++)
	{
		j = *p;
		eth_src_hw_addr[i] = j;
	}

    EA = EA_state;                  				// restore interrupt state
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   