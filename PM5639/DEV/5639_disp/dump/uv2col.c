

/* TABLE FOR CORRELATED COLOR TEMPERATURE */

code float TT[23][5] =
  {
/*      1/øK       u        v      slope   sqrt(1+slope*slope)            */
        [0]       [1]      [2]       [3]       [4]
    { 1/16667., 0.18494, 0.28020,  -0.3515, 1.059977},
    { 1/14286., 0.18611, 0.28340,  -0.3790, 1.069412},
    { 1/12500., 0.18739, 0.28666,  -0.4094, 1.080559},
    { 1/11111., 0.18879, 0.28995,  -0.4426, 1.093570},
    { 1/10000., 0.19031, 0.29325,  -0.4787, 1.108672},
    {  1/8000., 0.19461, 0.30139,  -0.5817, 1.156882},
    {  1/6667., 0.19960, 0.30918,  -0.7043, 1.223127},
    {  1/5714., 0.20523, 0.31645,  -0.8484, 1.311405},
    {  1/5000., 0.21140, 0.32309,  -1.017,  1.426285},
    {  1/4444., 0.21804, 0.32906,  -1.216,  1.574375},
    {  1/4000., 0.22507, 0.33436,  -1.450,  1.761391},
    {  1/3636., 0.23243, 0.33901,  -1.728,  1.996493},
    {  1/3333., 0.24005, 0.34305,  -2.061,  2.290790},
    {  1/3077., 0.24787, 0.34653,  -2.465,  2.660117},
    {  1/2857., 0.25585, 0.34948,  -2.960,  3.124356},
    {  1/2667., 0.26394, 0.35198,  -3.576,  3.713189},
    {  1/2500., 0.27210, 0.35405,  -4.355,  4.468336},
    {  1/2353., 0.28032, 0.35575,  -5.365,  5.457401},
    {  1/2222., 0.28854, 0.35713,  -6.711,  6.785096},
    {  1/2105., 0.29676, 0.35822,  -8.572,  8.630132},
    {  1/2000., 0.30496, 0.35906, -11.29,  11.334200},
    {  1/1905., 0.31310, 0.35968, -15.56,  15.592101},
    {  1/1818., 0.32119, 0.36011, -23.20,  23.221542},
  };

/***************************************************************************/
/*  CalculateTempKor                                                       */
/*                                                                         */
/* Written by:   Kim Engedahl, DEV                                         */
/*  Revised by:  Kim Engedahl, DEV                                         */
/*  Date:       921001                                                     */
/*  Revised:    951005                                                     */
/*                                                                         */
/* Module:     RUN.C                                                       */
/*  Function:  Calculate the correlated color temperature                  */
/*  Syntax:    float CalculateTempKor(void);                               */
/*  Remarks:    ----                                                       */
/*  Returns:    A float containing the correlated color temperature        */
/*  Updates:    ----                                                       */
/***************************************************************************/
float CalculateTempKor(void)
  {
  float d1, d2, tmp1, tmp2;
  bit TempFound = 0;
  data char KLine = 12;

  do
    {
    d1   = ((vval-TT[KLine+1][2])-TT[KLine+1][3]*(uval-TT[KLine+1][1]))/
              TT[KLine+1][4];

    tmp1 = vval-TT[KLine][2];  
    tmp2 = uval-TT[KLine][1];

    d2   = (tmp1-TT[KLine][3]*tmp2)/TT[KLine][4];

    if ((d1 > 0) && (d2 > 0)) 
      KLine += 1;
    else 
      if ((d1 < 0) && (d2 < 0)) 
        KLine -= 1;
      else                        /* if ((d1 < 0) || (d2 < 0)) */
        TempFound = 1;

    } while ((KLine >= 0) && (KLine <= (MaxTable - 1)) && !TempFound);

  if (TempFound)
    {
    d1 = fabs(d1);
    d2 = fabs(d2);

    if (sqrt(tmp1*tmp1 + tmp2*tmp2) > 0.0385)
      return (0.);

    return(1/(TT[KLine+1][0] + 
            (d1* (TT[KLine][0] - TT[KLine+1][0])/(d1+d2))));
    }
  else 
    return (0.);
  }
